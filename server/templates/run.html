{% extends "base.html" %}
{% block content %}
  {% set run_status = (run.status or "")|lower %}

  <div class="rounded-3xl border border-zinc-800/80 bg-zinc-950/55 p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.02)]">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Village Council</h1>
        <p class="mt-1 text-sm text-zinc-400">
          Three plans. One decision. Evidence-linked.
          {% if shift and shift.title %}
            <span class="text-zinc-600">Shift: <span class="text-zinc-300">{{ shift.title }}</span>.</span>
          {% endif %}
        </p>

        <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
          <span class="rounded-full border px-2.5 py-1 font-semibold
            {% if run_status == 'completed' %}border-emerald-500/40 bg-emerald-500/10 text-emerald-200
            {% elif run_status == 'running' %}border-amber-500/40 bg-amber-500/10 text-amber-200
            {% elif run_status == 'failed' %}border-rose-500/40 bg-rose-500/10 text-rose-200
            {% else %}border-zinc-700/80 bg-zinc-950/30 text-zinc-300{% endif %}">
            {{ run.status }}
          </span>
          <span class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 text-zinc-400">run {{ run['_id'] }}</span>
          {% if run.council_mode %}
            <span class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 text-zinc-400">mode {{ run.council_mode }}</span>
          {% endif %}
          {% if run_status == 'running' %}
            <span class="text-zinc-500">Live updating…</span>
          {% endif %}
        </div>

        <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-zinc-500">
          {% if prev_run %}
            <a class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 hover:border-zinc-700/80" href="/shifts/{{ shift_id }}/runs/{{ prev_run['_id'] }}">
              ← prev run
            </a>
          {% endif %}
          {% if next_run %}
            <a class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 hover:border-zinc-700/80" href="/shifts/{{ shift_id }}/runs/{{ next_run['_id'] }}">
              next run →
            </a>
          {% endif %}
        </div>
      </div>

      <div class="flex flex-wrap gap-2">
        <a href="/shifts/{{ shift_id }}" class="rounded-2xl border border-zinc-800/80 bg-zinc-950/50 px-4 py-2 text-sm font-semibold text-zinc-300 hover:border-zinc-700/80">
          Back to shift
        </a>
        <details id="export-menu" class="relative">
          <summary class="cursor-pointer rounded-2xl border border-zinc-800/80 bg-zinc-950/50 px-4 py-2 text-sm font-semibold text-zinc-200 hover:border-zinc-700/80">
            Export
          </summary>
          <div class="absolute right-0 mt-2 w-64 overflow-hidden rounded-2xl border border-zinc-800/80 bg-zinc-950/95 shadow-[0_16px_60px_-40px_rgba(0,0,0,0.9)]">
            <div class="grid">
              <button id="copy-link" class="px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-900/60">
                Copy link
              </button>

              {% if artifact %}
                <a href="/shifts/{{ shift_id }}/runs/{{ run['_id'] }}/handoff.md" class="px-4 py-2.5 text-left text-sm font-semibold text-zinc-100 hover:bg-zinc-900/60">
                  Download handoff
                </a>
              {% else %}
                <div class="px-4 py-2.5 text-left text-sm text-zinc-500">
                  {% if run_status == 'running' %}Generating handoff…{% else %}Handoff unavailable{% endif %}
                </div>
              {% endif %}

              <button
                id="copy-handoff"
                data-url="/shifts/{{ shift_id }}/runs/{{ run['_id'] }}/handoff.md?raw=1"
                class="px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-900/60 disabled:opacity-50"
                {% if not artifact %}disabled{% endif %}
              >
                Copy handoff
              </button>

              <div class="border-t border-zinc-800/80"></div>

              {% if council_artifact or live_council_count %}
                <a href="/shifts/{{ shift_id }}/runs/{{ run['_id'] }}/council.md" class="px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-900/60">
                  Download transcript
                </a>
              {% else %}
                <div class="px-4 py-2.5 text-left text-sm text-zinc-500">
                  Council transcript not ready
                </div>
              {% endif %}

              <button
                id="copy-council"
                data-url="/shifts/{{ shift_id }}/runs/{{ run['_id'] }}/council.md?raw=1"
                class="px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-900/60 disabled:opacity-50"
                {% if not (council_artifact or live_council_count) %}disabled{% endif %}
              >
                Copy transcript
              </button>
            </div>
          </div>
        </details>
      </div>
    </div>

  </div>

  {% include "fragments/run_main.html" %}
{% endblock %}

{% block scripts %}
  <script>
    (function () {
      function closeExportMenu() {
        const details = document.getElementById("export-menu");
        if (details) details.open = false;
      }

      async function copyFromUrl(btn) {
        const url = btn.getAttribute("data-url");
        if (!url) return;
        const prev = btn.textContent;
        btn.textContent = "Copying…";
        btn.disabled = true;
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const txt = await res.text();
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(txt);
          } else {
            const el = document.createElement("textarea");
            el.value = txt;
            el.style.position = "fixed";
            el.style.left = "-9999px";
            document.body.appendChild(el);
            el.focus();
            el.select();
            document.execCommand("copy");
            document.body.removeChild(el);
          }
          btn.textContent = "Copied";
          window.setTimeout(() => (btn.textContent = prev), 900);
        } catch (e) {
          btn.textContent = "Copy failed";
          window.setTimeout(() => (btn.textContent = prev), 1200);
        } finally {
          btn.disabled = false;
        }
        closeExportMenu();
      }

      document.addEventListener("click", (e) => {
        const btn = e.target && e.target.closest ? e.target.closest("button[data-url]") : null;
        if (!btn) return;
        if (btn.disabled) return;
        e.preventDefault();
        copyFromUrl(btn);
      });
      const linkBtn = document.getElementById("copy-link");
      if (linkBtn) {
        linkBtn.addEventListener("click", async () => {
          const prev = linkBtn.textContent;
          linkBtn.textContent = "Copied";
          try {
            const href = window.location.href;
            if (navigator.clipboard && window.isSecureContext) await navigator.clipboard.writeText(href);
            else {
              const el = document.createElement("textarea");
              el.value = href;
              el.style.position = "fixed";
              el.style.left = "-9999px";
              document.body.appendChild(el);
              el.focus();
              el.select();
              document.execCommand("copy");
              document.body.removeChild(el);
            }
          } catch (e) {
            linkBtn.textContent = "Copy failed";
          }
          window.setTimeout(() => (linkBtn.textContent = prev), 900);
          closeExportMenu();
        });
      }

      window.addEventListener("click", (e) => {
        const details = document.getElementById("export-menu");
        if (!details || !details.open) return;
        if (details.contains(e.target)) return;
        details.open = false;
      });

      function applyRunTabs(root) {
        const container = (root || document).getElementById("run-main");
        if (!container) return;
        const buttons = Array.from(container.querySelectorAll("[data-tab]"));
        const panels = Array.from(container.querySelectorAll("[data-tab-panel]"));
        if (!buttons.length || !panels.length) return;

        const defaultTab = container.getAttribute("data-default-tab") || "handoff";
        const stored = window.localStorage ? localStorage.getItem("babyhandoff.runTab") : null;
        let active = stored || defaultTab;
        if (!panels.some((p) => p.getAttribute("data-tab-panel") === active)) active = defaultTab;

        for (const panel of panels) {
          const name = panel.getAttribute("data-tab-panel");
          panel.classList.toggle("hidden", name !== active);
        }
        for (const btn of buttons) {
          const name = btn.getAttribute("data-tab");
          const on = name === active;
          btn.setAttribute("aria-selected", on ? "true" : "false");
          btn.setAttribute("tabindex", on ? "0" : "-1");
          btn.classList.toggle("border-zinc-700/80", on);
          btn.classList.toggle("bg-zinc-950/70", on);
          btn.classList.toggle("text-zinc-100", on);
          btn.classList.toggle("text-zinc-300", !on);
        }
      }

      document.addEventListener("click", (e) => {
        const btn = e.target && e.target.closest ? e.target.closest("[data-tab]") : null;
        if (!btn) return;
        const container = btn.closest("#run-main");
        if (!container) return;
        const name = btn.getAttribute("data-tab");
        if (!name) return;
        if (window.localStorage) localStorage.setItem("babyhandoff.runTab", name);
        applyRunTabs(document);
      });

      document.addEventListener("keydown", (e) => {
        const activeTab = e.target && e.target.closest ? e.target.closest("[data-tab][role='tab']") : null;
        if (!activeTab) return;
        if (!["ArrowLeft", "ArrowRight", "Home", "End"].includes(e.key)) return;
        const container = activeTab.closest("#run-main");
        if (!container) return;

        const tabs = Array.from(container.querySelectorAll("[data-tab][role='tab']"));
        if (!tabs.length) return;
        const idx = Math.max(0, tabs.indexOf(activeTab));
        let nextIdx = idx;
        if (e.key === "ArrowLeft") nextIdx = (idx - 1 + tabs.length) % tabs.length;
        if (e.key === "ArrowRight") nextIdx = (idx + 1) % tabs.length;
        if (e.key === "Home") nextIdx = 0;
        if (e.key === "End") nextIdx = tabs.length - 1;
        const nextTab = tabs[nextIdx];
        if (!nextTab) return;
        e.preventDefault();
        nextTab.focus();
        const name = nextTab.getAttribute("data-tab");
        if (window.localStorage) localStorage.setItem("babyhandoff.runTab", name);
        applyRunTabs(document);
      });

      applyRunTabs(document);
      document.body.addEventListener("htmx:afterSwap", (e) => applyRunTabs(e.target));

      function maybeSwitchTabForHash(hash) {
        if (!hash || !hash.startsWith("#")) return;
        const id = hash.slice(1);
        if (!id) return;
        const el = document.getElementById(id);
        if (!el) return;
        const panel = el.closest("[data-tab-panel]");
        if (!panel) return;
        const tab = panel.getAttribute("data-tab-panel");
        if (!tab) return;
        if (window.localStorage) localStorage.setItem("babyhandoff.runTab", tab);
        applyRunTabs(document);
      }

      document.addEventListener("click", (e) => {
        const a = e.target && e.target.closest ? e.target.closest("a[href^='#']") : null;
        if (!a) return;
        maybeSwitchTabForHash(a.getAttribute("href"));
      });

      window.addEventListener("hashchange", () => maybeSwitchTabForHash(window.location.hash));
      maybeSwitchTabForHash(window.location.hash);
    })();
  </script>
{% endblock %}
