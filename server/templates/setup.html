{% extends "base.html" %}
{% block content %}
  <div class="mx-auto max-w-3xl">
    <div class="rounded-3xl border border-zinc-800/80 bg-zinc-950/55 p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.02)]">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold tracking-tight">Connect MongoDB Atlas</h1>
          <p class="mt-1 text-sm text-zinc-400">
            BabyHandoff needs MongoDB Atlas to store durable context and the agent audit trail.
          </p>
        </div>
        <a
          href="/health"
          class="rounded-2xl border border-zinc-800/80 bg-zinc-950/50 px-4 py-2 text-sm font-semibold text-zinc-300 hover:border-zinc-700/80"
        >
          Health JSON
        </a>
      </div>
    </div>

    <div class="mt-6 rounded-3xl border border-zinc-800/80 bg-zinc-950/55 p-5 shadow-[0_0_0_1px_rgba(255,255,255,0.02)]">
      <div class="text-sm font-semibold">Status</div>
      <div class="mt-3 grid gap-3 text-sm">
        <div class="flex items-center justify-between">
          <div class="text-zinc-400">Mongo</div>
          {% if mongo_ok %}
            <div class="rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200">
              Connected
            </div>
          {% else %}
            <div class="rounded-full border border-rose-500/40 bg-rose-500/10 px-3 py-1 text-xs font-semibold text-rose-200">
              Not connected
            </div>
          {% endif %}
        </div>
        {% if mongo_error %}
          <div class="rounded-2xl border border-zinc-800/80 bg-zinc-950/40 px-3 py-2 text-xs text-zinc-300">
            <div class="text-zinc-500">Error</div>
            <div class="mt-1 whitespace-pre-wrap">{{ mongo_error }}</div>
          </div>
        {% endif %}

        <div class="flex items-center justify-between">
          <div class="text-zinc-400">Indexes</div>
          {% if indexes_ok %}
            <div class="rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200">
              OK
            </div>
          {% else %}
            <div class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-3 py-1 text-xs font-semibold text-zinc-300">
              Pending
            </div>
          {% endif %}
        </div>
        {% if indexes_error %}
          <div class="rounded-2xl border border-zinc-800/80 bg-zinc-950/40 px-3 py-2 text-xs text-zinc-300">
            <div class="text-zinc-500">Indexes error</div>
            <div class="mt-1 whitespace-pre-wrap">{{ indexes_error }}</div>
          </div>
        {% endif %}

        <div class="flex items-center justify-between">
          <div class="text-zinc-400">Watchers</div>
          {% if change_streams_enabled %}
            <div class="rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200">
              Change streams on
            </div>
          {% else %}
            <div class="rounded-full border border-amber-500/40 bg-amber-500/10 px-3 py-1 text-xs font-semibold text-amber-200">
              Fallback mode
            </div>
          {% endif %}
        </div>

        <div class="flex items-center justify-between">
          <div class="text-zinc-400">Council</div>
          <div class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-3 py-1 text-xs font-semibold text-zinc-200">
            {{ council_mode }}
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6 rounded-3xl border border-zinc-800/80 bg-zinc-950/55 p-5 shadow-[0_0_0_1px_rgba(255,255,255,0.02)]">
      <div class="text-sm font-semibold">Fix it in Atlas</div>
      <ol class="mt-3 list-decimal space-y-2 pl-5 text-sm text-zinc-300">
        <li>
          Create a DB user:
          <span class="text-zinc-500">Security → Database Access → Add New Database User</span>
        </li>
        <li>
          Allow your IP:
          <span class="text-zinc-500">Security → Database &amp; Network Access → Add IP Address</span>
        </li>
        <li>
          Copy your URI:
          <span class="text-zinc-500">Database → Clusters → Connect → Drivers</span>
        </li>
        <li>
          Set repo env vars in <code class="text-zinc-200">.env</code>:
        </li>
      </ol>
      <pre class="mt-4 overflow-x-auto rounded-2xl border border-zinc-800/80 bg-zinc-950/40 px-4 py-3 text-xs text-zinc-300"><code>MONGODB_URI=mongodb+srv://&lt;user&gt;:&lt;urlencoded_password&gt;@cluster0.&lt;id&gt;.mongodb.net/?retryWrites=true&amp;w=majority
MONGODB_DB=babyhandoff</code></pre>
      <div class="mt-3 text-xs text-zinc-500">
        Tip: use the Atlas “Drivers” URI ending with <code class="text-zinc-300">/</code> (this app selects the DB via
        <code class="text-zinc-300">MONGODB_DB</code>). URL-encode password chars (e.g. <code class="text-zinc-300">@</code> →
        <code class="text-zinc-300">%40</code>).
      </div>
    </div>

    <div class="mt-6 text-xs text-zinc-500">
      After updating <code class="text-zinc-300">.env</code>, restart the dev server and refresh this page.
    </div>
  </div>
{% endblock %}
