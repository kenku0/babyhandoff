<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title if title else "BabyHandoff" }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body class="bg-zinc-950 text-zinc-100 selection:bg-zinc-200/15 selection:text-zinc-100">
    <div class="min-h-screen">
      <header class="sticky top-0 z-50 border-b border-zinc-800/80 bg-zinc-950/90 backdrop-blur">
        <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
          <a href="/" class="flex items-center gap-3">
            <img
              src="/static/logo.svg"
              alt="BabyHandoff logo"
              class="h-9 w-9 rounded-xl border border-zinc-800/80 bg-zinc-950/50 object-cover"
              loading="eager"
            />
            <div>
              <div class="text-base font-semibold leading-5">BabyHandoff</div>
              <div class="text-xs text-zinc-400">It takes a village.</div>
            </div>
          </a>
          <div class="flex items-center gap-2">
            {% set watchers_on = request.app.state.change_streams_enabled %}
            {% set council_mode = request.app.state.settings.council_mode %}
            {% set openai_key = request.app.state.settings.openai_api_key %}
            {% set anthropic_key = request.app.state.settings.anthropic_api_key %}
            {% set gemini_key = request.app.state.settings.gemini_api_key %}
            {% set llm_ready = (council_mode == 'openai' and openai_key) or (council_mode == 'multi' and (openai_key or anthropic_key or gemini_key)) %}
            {% set llm_missing = (council_mode in ['openai','multi']) and (not llm_ready) %}
            {% set llm_partial = (council_mode == 'multi') and llm_ready and (not (openai_key and anthropic_key and gemini_key)) %}
            {% set demo = request.app.state.settings.demo_mode %}
            {% set status_ok = watchers_on and (not llm_missing) %}
            <details id="status-menu" class="relative">
              <summary class="cursor-pointer rounded-2xl border border-zinc-800/80 bg-zinc-950/50 px-3 py-2 text-xs font-semibold text-zinc-200 hover:border-zinc-700/80">
                <span class="inline-flex items-center gap-2">
                  <span class="h-1.5 w-1.5 rounded-full {% if status_ok %}bg-emerald-400{% else %}bg-amber-400{% endif %}"></span>
                  Status
                </span>
              </summary>
              <div class="absolute right-0 mt-2 w-80 overflow-hidden rounded-2xl border border-zinc-800/80 bg-zinc-950/95 shadow-[0_16px_60px_-40px_rgba(0,0,0,0.9)]">
                <div class="grid gap-3 p-4 text-xs text-zinc-300">
                  <div class="flex items-start justify-between gap-4">
                    <div>
                      <div class="font-semibold text-zinc-100">Watchers</div>
                      <div class="mt-0.5 text-zinc-500">MongoDB change-stream triggers for durable, auto-updating context.</div>
                    </div>
                    <span class="rounded-full border px-2 py-1 font-semibold
                      {% if watchers_on %}border-emerald-500/40 bg-emerald-500/10 text-emerald-200
                      {% else %}border-amber-500/40 bg-amber-500/10 text-amber-200{% endif %}">
                      {{ "on" if watchers_on else "fallback" }}
                    </span>
                  </div>

                  <div class="flex items-start justify-between gap-4">
                    <div>
                      <div class="font-semibold text-zinc-100">Council</div>
                      <div class="mt-0.5 text-zinc-500">Planning engine and referee mode.</div>
                    </div>
                    <span class="rounded-full border px-2 py-1 font-semibold
                      {% if llm_ready %}border-indigo-500/40 bg-indigo-500/10 text-indigo-200
                      {% elif council_mode in ['openai','multi'] %}border-amber-500/40 bg-amber-500/10 text-amber-200
                      {% else %}border-zinc-800/80 bg-zinc-950/50 text-zinc-300{% endif %}">
                      {{ council_mode }}{% if llm_missing %} (keys missing){% elif llm_partial %} (partial){% endif %}
                    </span>
                  </div>

                  {% if demo %}
                    <div class="flex items-start justify-between gap-4">
                      <div>
                        <div class="font-semibold text-zinc-100">Demo</div>
                        <div class="mt-0.5 text-zinc-500">Sample shift + deterministic defaults for judging.</div>
                      </div>
                      <span class="rounded-full border border-zinc-800/80 bg-zinc-950/50 px-2 py-1 text-zinc-300">on</span>
                    </div>
                  {% endif %}

                  <div class="border-t border-zinc-800/80 pt-3">
                    <a href="/setup" class="inline-flex items-center justify-center rounded-xl border border-zinc-800/80 bg-zinc-950/50 px-3 py-2 text-xs font-semibold text-zinc-200 hover:border-zinc-700/80">
                      Setup / health
                    </a>
                  </div>
                </div>
              </div>
            </details>
          </div>
        </div>
      </header>
      <main class="mx-auto max-w-7xl px-6 py-8">
        {% block content %}{% endblock %}
      </main>
      <footer class="mx-auto max-w-7xl px-6 py-10 text-xs text-zinc-500">
        <div class="border-t border-zinc-800/80 pt-6">
          <div class="flex flex-col items-center gap-2 text-center">
            <div class="text-zinc-400">
              BabyHandoff is a planning tool. It does not provide medical advice.
            </div>
            <div class="text-[11px] text-zinc-600">
              Open source Â· MIT License
            </div>
          </div>
        </div>
      </footer>
    </div>
    <script>
      (function () {
        const fmtClock = new Intl.DateTimeFormat(undefined, { hour: "numeric", minute: "2-digit" });
        const fmtFull = new Intl.DateTimeFormat(undefined, {
          year: "numeric",
          month: "short",
          day: "2-digit",
          hour: "numeric",
          minute: "2-digit",
        });
        const fmtMonthDay = new Intl.DateTimeFormat(undefined, { month: "short", day: "2-digit" });

        function formatRelative(dt) {
          const now = new Date();
          const diffMs = now - dt;
          const s = Math.floor(diffMs / 1000);
          const m = Math.floor(s / 60);
          const h = Math.floor(m / 60);
          const d = Math.floor(h / 24);
          if (s < 10) return "just now";
          if (m < 1) return `${s}s ago`;
          if (h < 1) return `${m}m ago`;
          if (d < 1) return `${h}h ago`;
          return `${d}d ago`;
        }

        function formatLocalLabel(dt) {
          const now = new Date();
          const sameDay =
            dt.getFullYear() === now.getFullYear() &&
            dt.getMonth() === now.getMonth() &&
            dt.getDate() === now.getDate();
          if (sameDay) return `Today ${fmtClock.format(dt)}`;
          return `${fmtMonthDay.format(dt)} ${fmtClock.format(dt)}`;
        }

        function applyTimeFormatting(root) {
          const times = (root || document).querySelectorAll("time[data-time][datetime]");
          for (const el of times) {
            const dt = new Date(el.getAttribute("datetime"));
            if (!dt || Number.isNaN(dt.valueOf())) continue;
            el.title = fmtFull.format(dt);
            const mode = el.getAttribute("data-time");
            if (mode === "relative") el.textContent = formatRelative(dt);
            if (mode === "local") el.textContent = formatLocalLabel(dt);
          }
        }

        function applyPersistedDetails(root) {
          const detailsEls = (root || document).querySelectorAll("details[data-persist]");
          for (const details of detailsEls) {
            const key = details.getAttribute("data-persist");
            if (!key) continue;
            const storageKey = "details:" + key;
            const defaultMode = details.getAttribute("data-default-open");
            let saved;
            try {
              saved = window.localStorage ? localStorage.getItem(storageKey) : null;
            } catch (_) {
              saved = null;
            }

            if (saved === "open") details.open = true;
            else if (saved === "closed") details.open = false;
            else if (defaultMode === "open") details.open = true;
            else if (defaultMode === "closed") details.open = false;

            if (details.dataset.persistBound) continue;
            details.dataset.persistBound = "1";
            details.addEventListener("toggle", () => {
              try {
                if (window.localStorage) localStorage.setItem(storageKey, details.open ? "open" : "closed");
              } catch (_) {}
            });
          }
        }

        applyTimeFormatting(document);
        applyPersistedDetails(document);
        document.body.addEventListener("htmx:afterSwap", (e) => {
          applyTimeFormatting(e.target);
          applyPersistedDetails(e.target);
        });

        window.addEventListener("click", (e) => {
          const menu = document.getElementById("status-menu");
          if (!menu || !menu.open) return;
          if (menu.contains(e.target)) return;
          menu.open = false;
        });
      })();
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
