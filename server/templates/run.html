{% extends "base.html" %}
{% block content %}
  {% set run_status = (run.status or "")|lower %}

  <div class="rounded-3xl border border-zinc-800/80 bg-zinc-950/55 p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.02)]">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Village Council</h1>
        <p class="mt-1 text-sm text-zinc-400">
          Three plans. One decision. Evidence-linked.
          {% if shift and shift.title %}
            <span class="text-zinc-600">Shift: <span class="text-zinc-300">{{ shift.title }}</span>.</span>
          {% endif %}
        </p>

        <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
          <span class="rounded-full border px-2.5 py-1 font-semibold
            {% if run_status == 'completed' %}border-emerald-500/40 bg-emerald-500/10 text-emerald-200
            {% elif run_status == 'running' %}border-amber-500/40 bg-amber-500/10 text-amber-200
            {% elif run_status == 'failed' %}border-rose-500/40 bg-rose-500/10 text-rose-200
            {% else %}border-zinc-700/80 bg-zinc-950/30 text-zinc-300{% endif %}">
            {{ run.status }}
          </span>
          <span class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 text-zinc-400">run {{ run['_id'] }}</span>
          {% if run.council_mode %}
            <span class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 text-zinc-400">mode {{ run.council_mode }}</span>
          {% endif %}
          {% if run_status == 'running' %}
            <span class="text-zinc-500">Live updating…</span>
          {% endif %}
        </div>

        <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-zinc-500">
          {% if prev_run %}
            <a class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 hover:border-zinc-700/80" href="/shifts/{{ shift_id }}/runs/{{ prev_run['_id'] }}">
              ← prev run
            </a>
          {% endif %}
          {% if next_run %}
            <a class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 hover:border-zinc-700/80" href="/shifts/{{ shift_id }}/runs/{{ next_run['_id'] }}">
              next run →
            </a>
          {% endif %}
          <span class="hidden text-zinc-600 lg:inline">Jump:</span>
          <a class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 hover:border-zinc-700/80" href="#decision-card">Decision</a>
          <a class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 hover:border-zinc-700/80" href="#handoff">Handoff</a>
          <a class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1 hover:border-zinc-700/80" href="#village-activity">Activity</a>
        </div>
      </div>

      <div class="flex flex-wrap gap-2">
        <a href="/shifts/{{ shift_id }}" class="rounded-2xl border border-zinc-800/80 bg-zinc-950/50 px-4 py-2 text-sm font-semibold text-zinc-300 hover:border-zinc-700/80">
          Back to shift
        </a>
        <details id="export-menu" class="relative">
          <summary class="cursor-pointer rounded-2xl border border-zinc-800/80 bg-zinc-950/50 px-4 py-2 text-sm font-semibold text-zinc-200 hover:border-zinc-700/80">
            Export
          </summary>
          <div class="absolute right-0 mt-2 w-64 overflow-hidden rounded-2xl border border-zinc-800/80 bg-zinc-950/95 shadow-[0_16px_60px_-40px_rgba(0,0,0,0.9)]">
            <div class="grid">
              <button id="copy-link" class="px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-900/60">
                Copy link
              </button>

              {% if artifact %}
                <a href="/shifts/{{ shift_id }}/runs/{{ run['_id'] }}/handoff.md" class="px-4 py-2.5 text-left text-sm font-semibold text-zinc-100 hover:bg-zinc-900/60">
                  Download handoff
                </a>
              {% else %}
                <div class="px-4 py-2.5 text-left text-sm text-zinc-500">
                  {% if run_status == 'running' %}Generating handoff…{% else %}Handoff unavailable{% endif %}
                </div>
              {% endif %}

              <button
                id="copy-handoff"
                data-url="/shifts/{{ shift_id }}/runs/{{ run['_id'] }}/handoff.md?raw=1"
                class="px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-900/60 disabled:opacity-50"
                {% if not artifact %}disabled{% endif %}
              >
                Copy handoff
              </button>

              <div class="border-t border-zinc-800/80"></div>

              {% if council_artifact or live_council_count %}
                <a href="/shifts/{{ shift_id }}/runs/{{ run['_id'] }}/council.md" class="px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-900/60">
                  Download transcript
                </a>
              {% else %}
                <div class="px-4 py-2.5 text-left text-sm text-zinc-500">
                  Council transcript not ready
                </div>
              {% endif %}

              <button
                id="copy-council"
                data-url="/shifts/{{ shift_id }}/runs/{{ run['_id'] }}/council.md?raw=1"
                class="px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-900/60 disabled:opacity-50"
                {% if not (council_artifact or live_council_count) %}disabled{% endif %}
              >
                Copy transcript
              </button>
            </div>
          </div>
        </details>
      </div>
    </div>

    <div class="mt-5 border-t border-zinc-800/80 pt-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="text-sm font-semibold">What-if re-run</div>
        <form action="/shifts/{{ shift_id }}/runs" method="post" class="flex flex-wrap items-center gap-2">
          <div class="text-xs text-zinc-500">Energy</div>
          {% set energy_selected = (run.energy_override or "")|lower %}
          {% for (value, label) in [("","Auto"),("high","High"),("medium","Medium"),("low","Low")] %}
            <label class="cursor-pointer">
              <input class="peer sr-only" type="radio" name="energy" value="{{ value }}" {% if value == energy_selected %}checked{% endif %} />
              <span class="inline-flex items-center rounded-full border border-zinc-800/80 bg-zinc-950/40 px-3 py-1 text-xs text-zinc-300 transition peer-checked:border-indigo-500/40 peer-checked:bg-indigo-500/10 peer-checked:text-indigo-200 hover:border-zinc-700/80">
                {{ label }}
              </span>
            </label>
          {% endfor %}
          <button class="rounded-2xl border border-zinc-800/80 bg-zinc-950/50 px-3 py-1.5 text-xs font-semibold text-zinc-200 hover:border-zinc-700/80">
            Re-run council
          </button>
        </form>
      </div>
      <div class="mt-2 text-xs text-zinc-500">
        Creates a new run and shows a v1→v2 diff in the handoff card.
      </div>
    </div>
  </div>

  {% include "fragments/run_main.html" %}
{% endblock %}

{% block scripts %}
  <script>
    (function () {
      function closeExportMenu() {
        const details = document.getElementById("export-menu");
        if (details) details.open = false;
      }

      async function copyFromUrl(btn) {
        const url = btn.getAttribute("data-url");
        if (!url) return;
        const prev = btn.textContent;
        btn.textContent = "Copying…";
        btn.disabled = true;
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const txt = await res.text();
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(txt);
          } else {
            const el = document.createElement("textarea");
            el.value = txt;
            el.style.position = "fixed";
            el.style.left = "-9999px";
            document.body.appendChild(el);
            el.focus();
            el.select();
            document.execCommand("copy");
            document.body.removeChild(el);
          }
          btn.textContent = "Copied";
          window.setTimeout(() => (btn.textContent = prev), 900);
        } catch (e) {
          btn.textContent = "Copy failed";
          window.setTimeout(() => (btn.textContent = prev), 1200);
        } finally {
          btn.disabled = false;
        }
        closeExportMenu();
      }

      const handoffBtn = document.getElementById("copy-handoff");
      if (handoffBtn) handoffBtn.addEventListener("click", () => copyFromUrl(handoffBtn));
      const councilBtn = document.getElementById("copy-council");
      if (councilBtn) councilBtn.addEventListener("click", () => copyFromUrl(councilBtn));
      const linkBtn = document.getElementById("copy-link");
      if (linkBtn) {
        linkBtn.addEventListener("click", async () => {
          const prev = linkBtn.textContent;
          linkBtn.textContent = "Copied";
          try {
            const href = window.location.href;
            if (navigator.clipboard && window.isSecureContext) await navigator.clipboard.writeText(href);
            else {
              const el = document.createElement("textarea");
              el.value = href;
              el.style.position = "fixed";
              el.style.left = "-9999px";
              document.body.appendChild(el);
              el.focus();
              el.select();
              document.execCommand("copy");
              document.body.removeChild(el);
            }
          } catch (e) {
            linkBtn.textContent = "Copy failed";
          }
          window.setTimeout(() => (linkBtn.textContent = prev), 900);
          closeExportMenu();
        });
      }

      window.addEventListener("click", (e) => {
        const details = document.getElementById("export-menu");
        if (!details || !details.open) return;
        if (details.contains(e.target)) return;
        details.open = false;
      });
    })();
  </script>
{% endblock %}
